<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Impacto Atmosferico V3.15: Simulaci√≥n Atmosf√©rica - Revisado</title>
<style>
/* ------------------------------
   CSS: Estabilidad (Fixed Structure)
   ------------------------------ */
:root {
  --topbar-height: 80px; 
  --color-primary: #2db1ff; 
  --color-secondary: #ff9f40;
  --color-tertiary: #d3e605;
  --color-uv: rgba(255, 213, 79, 0.1); /* Color UV */
  --color-light: #ffd54f; 
  --color-cfc: #82c42b;
  --color-acid: #b0c4de;
  --color-bg-light: #E0F7FA;
  --color-bg-dark: #87CEFA; /* Fondo Azul Claro/Cielo */
  --color-header-bg: linear-gradient(90deg, #0b3550, #062f44);
  --shadow-l: 0 8px 20px rgba(2, 12, 20, 0.35);
  --shadow-btn: 0 6px 12px rgba(0, 0, 0, 0.35); 
}

html, body { 
  height: 100%; 
  margin: 0; 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  -webkit-user-select: none; 
  user-select: none; 
  touch-action: none; 
  overflow: hidden; 
  background-color: var(--color-bg-light); /* Fondo del body por si falla el canvas */
}

/* Canvas ocupa toda la pantalla */
canvas { 
  position: fixed; 
  left: 0; 
  top: 0; 
  width: 100vw; 
  height: 100vh; 
  display: block; 
  z-index: 1; 
  background-color: var(--color-bg-dark); /* Fondo del canvas, refuerzo */
}

/* Topbar superpuesta, fixed */
#topbar { 
  position: fixed; 
  left: 1%; 
  right: 1%; 
  top: 1%; 
  height: var(--topbar-height); 
  z-index: 60; 
  background: var(--color-header-bg); 
  color: #fff; 
  border-radius: 12px; 
  display: flex; 
  align-items: center; 
  gap: 14px; 
  padding: 10px 16px; 
  box-shadow: var(--shadow-l); 
  min-height: 70px;
}
#title { font-weight: 700; font-size: clamp(16px, 2.5vw, 22px); }
#subtitle { font-size: clamp(12px, 1.8vw, 15px); color: #cfefff; }
#reaction { 
  margin-left: 8px; 
  background: rgba(255, 255, 255, 0.08); 
  padding: 8px 12px; 
  border-radius: 8px; 
  color: #eaffff; 
  font-size: clamp(12px, 1.8vw, 15px); 
  min-width: 280px; 
  font-style: italic; 
  white-space: nowrap; 
  overflow: hidden;
  text-overflow: ellipsis;
}
.metrics { margin-left: auto; display: flex; gap: 10px; }
.metric { 
  background: rgba(255, 255, 255, 0.08); 
  padding: 6px 10px; 
  border-radius: 8px; 
  font-size: clamp(11px, 1.6vw, 14px); 
  text-align: center; 
}
.val { font-weight: 800; color: #fff; margin-top: 4px; font-size: clamp(14px, 2.2vw, 18px); }
.val.acid { color: var(--color-acid); }

/* Estilos de Botones, Controles, Modal, Leyenda... */
.roundBtn {
    width: 50px; height: 50px; border-radius: 50%; border: none;
    background-color: var(--color-primary); color: white;
    font-weight: bold; font-size: 1.2rem; cursor: pointer;
    box-shadow: var(--shadow-btn); transition: transform 0.1s;
}
.roundBtn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.45); }
.roundBtn.secondary { background-color: var(--color-secondary); }
.roundBtn.tertiary { background-color: var(--color-tertiary); }
.roundBtn.cfc { background-color: var(--color-cfc); }
.roundBtn.uv { background-color: var(--color-uv); font-size: 1.5rem; }
.roundBtn.light { background-color: var(--color-light); font-size: 1.5rem; }
#controls { position: fixed; left: 1.5%; bottom: 2%; z-index: 60; display: flex; flex-direction: column; gap: 12px; }
#legend { position: fixed; right: 1.5%; bottom: 2%; z-index: 60; background: rgba(2, 12, 20, 0.75); color: #e8f6ff; padding: 10px 14px; border-radius: 8px; font-size: clamp(12px, 1.8vw, 15px); max-width: 280px; box-shadow: var(--shadow-btn); }
#modal { 
  position: fixed; 
  left: 50%; 
  top: 50%; 
  transform: translate(-50%, -50%); 
  z-index: 120; 
  width: clamp(300px, 80vw, 600px); 
  max-height: 90vh; 
  overflow-y: auto; 
  background: rgba(8, 18, 28, 0.96); 
  color: #e6fbff; 
  border-radius: 16px; 
  padding: clamp(15px, 4vw, 25px); 
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8); 
  line-height: 1.5;
}
#modal table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
#modal th, #modal td {
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 8px;
  text-align: left;
}
#modal th {
  background-color: rgba(255, 255, 255, 0.1);
  font-weight: bold;
}
#modal td:first-child { 
  font-weight: bold;
  color: #a8d8ff;
}
.close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #aaa; }

</style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="topbar" role="banner" aria-live="polite">
  <div>
    <div id="title">Impacto Atmosf√©rico ‚Äî Simulador de Contaminantes y Reacciones</div>
    <div id="subtitle">Arrastra una mol√©cula sobre otra para que reaccionen.</div>
  </div>
  <div id="reaction">√öltima reacci√≥n: **Esperando interacci√≥n**</div>
  <div class="metrics" role="status">
    <div class="metric">Total<div id="totalVal" class="val">0</div></div>
    <div class="metric">O‚ÇÉ<div id="o3Val" class="val">0</div></div>
    <div class="metric">CFCs<div id="cfcVal" class="val">0</div></div>
    <div class="metric">√Åcidos<div id="h2so4Val" class="val acid">0</div></div>
  </div>
</div>

<div id="controls">
  <button title="A√±adir Di√≥xido de Carbono (CO‚ÇÇ)" class="roundBtn" data-type="CO2">CO‚ÇÇ</button>
  <button title="A√±adir Di√≥xido de Azufre (SO‚ÇÇ)" class="roundBtn tertiary" data-type="SO2">SO‚ÇÇ</button>
  <button title="A√±adir Di√≥xido de Nitr√≥geno (NO‚ÇÇ)" class="roundBtn secondary" data-type="NO2">NO‚ÇÇ</button>
  <button title="A√±adir Clorofluorocarbono (CFC)" class="roundBtn cfc" data-type="CFC">CFC</button>
  <button title="A√±adir Agua (H‚ÇÇO)" class="roundBtn" data-type="H2O">H‚ÇÇO</button>
  <button title="Liberar radiaci√≥n UV (simulando sol)" class="roundBtn uv" id="btnUV">‚òÄÔ∏è</button>
  <button title="Generar rayo (descarga el√©ctrica)" class="roundBtn light" id="btnLightning">‚ö°</button>
  <button id="popupBtn" title="Ver lista de combinaciones posibles">?</button>
</div>

<div id="modal" role="dialog" aria-modal="true" style="display:none;">
    <div class="close" id="closeModal" role="button" aria-label="Cerrar ventana emergente"><b>‚úï</b></div>
    
    <h2>üî¨ Gu√≠a R√°pida de Reacciones Atmosf√©ricas</h2>

<p>
  Arrastra dos mol√©culas hasta que se toquen para intentar formar una reacci√≥n.
  Usa el bot√≥n ‚òÄÔ∏è para generar <b>rayos UV</b> y ‚ö° para generar <b>rayos el√©ctricos</b>,
  los cuales act√∫an como energ√≠a o catalizadores.
</p>

<hr style="border-color: rgba(255,255,255,0.15); margin: 15px 0;">

<h3>1. üåç Ciclo del Ozono</h3>
<p>El ozono (O‚ÇÉ) protege a la Tierra de la radiaci√≥n UV, pero tambi√©n puede romperse.</p>

<table>
  <thead>
    <tr>
      <th>Proceso</th>
      <th>Ecuaci√≥n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><b>Formaci√≥n del Ozono</b></td>
      <td>O‚ÇÇ + O ‚Üí O‚ÇÉ</td>
    </tr>
    <tr>
      <td><b>Destrucci√≥n Natural (Filtro UV)</b></td>
      <td>‚òÄÔ∏è + O‚ÇÉ ‚Üí O‚ÇÇ + O</td>
    </tr>
    <tr>
      <td><b>Activaci√≥n de CFC</b></td>
      <td>‚òÄÔ∏è + CFC ‚Üí Cl (√°tomo de cloro)</td>
    </tr>
    <tr>
      <td><b>Ciclo Catal√≠tico del Cloro</b></td>
      <td>Cl + O‚ÇÉ ‚Üí ClO + O‚ÇÇ</td>
    </tr>
    <tr>
      <td><b>Destrucci√≥n por NO</b></td>
      <td>NO + O‚ÇÉ ‚Üí NO‚ÇÇ + O‚ÇÇ</td>
    </tr>
  </tbody>
</table>

<p style="opacity:0.75; margin-top:5px;">
  üîÅ Un solo √°tomo de Cl puede destruir miles de mol√©culas de O‚ÇÉ antes de inactivarse.
</p>

<hr style="border-color: rgba(255,255,255,0.15); margin: 15px 0;">

<h3>2. üåß Lluvia √Åcida: Formaci√≥n</h3>
<p>Se origina cuando NO‚Çì y SO‚ÇÇ reaccionan en la atm√≥sfera y generan √°cidos fuertes.</p>

<table>
  <thead>
    <tr>
      <th>Proceso</th>
      <th>Ecuaci√≥n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><b>Formaci√≥n de Radicales OH (energ√≠a UV)</b></td>
      <td>‚òÄÔ∏è + H‚ÇÇO ‚Üí OH + H</td>
    </tr>
    <tr>
      <td><b>Generaci√≥n de NO por rayos</b></td>
      <td>‚ö° + N‚ÇÇ + O‚ÇÇ ‚Üí NO</td>
    </tr>
    <tr>
      <td><b>√Åcido N√≠trico (HNO‚ÇÉ)</b></td>
      <td>NO‚ÇÇ + OH ‚Üí HNO‚ÇÉ</td>
    </tr>
    <tr>
      <td><b>√Åcido Sulf√∫rico (H‚ÇÇSO‚ÇÑ)</b></td>
      <td>SO‚ÇÇ + OH ‚Üí ‚Ä¶ ‚Üí H‚ÇÇSO‚ÇÑ</td>
    </tr>
  </tbody>
</table>

<p style="opacity:0.75; margin-top:5px;">
  üß™ Los √°cidos formados se disuelven en gotas de lluvia ‚Üí <b>lluvia √°cida</b>.
</p>

</div>
<script>
/* ------------------------------
    Canvas setup (FIXED)
    ------------------------------ */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha: false }); 
const topbar = document.getElementById('topbar');
let W, H; 
let INTERACT_TOP; 
let sunColor;

function resizeCanvas() {
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
    
    const topbarHeight = topbar.offsetHeight + H * 0.01; 
    INTERACT_TOP = topbarHeight + 50; 
    
    sun.x = Math.max(170, W * 0.08); 
    sun.y = Math.max(INTERACT_TOP - 20, H * 0.1); 
    
    createClouds();
}
window.addEventListener('resize', resizeCanvas);


/* ------------------------------
    Constants & state (Molecule Definitions)
    ------------------------------ */
let molecules = []; 
let effects = [];
let clouds = [];
let nextId = 1;
let selectedMolecule = null; 
const sun = { x: 90, y: 90, r: 36 }; 
const AIR_RESISTANCE = 0.95;
const BOUNDARY_DAMPING = 5;
const TOP_DAMPING = 0.85;
const GRAVITY_BOOST = -0.004;

const DEFS = {
    O2:    { label:'O‚ÇÇ', atoms:[{ax:-18,ay:0,rad:14,color:'#2abafa',label:'O'},{ax:18,ay:0,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1]] },
    O3:    { label:'O‚ÇÉ', atoms:[{ax:-18,ay:-8,rad:13,color:'#b388ff',label:'O'},{ax:18,ay:-8,rad:13,color:'#b388ff',label:'O'},{ax:0,ay:20,rad:13,color:'#b388ff',label:'O'}], bonds:[[0,1],[1,2],[2,0]] },
    CO2:   { label:'CO‚ÇÇ', atoms:[{ax:-28,ay:0,rad:14,color:'#2abafa',label:'O'},{ax:0,ay:0,rad:16,color:'#333',label:'C'},{ax:28,ay:0,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1],[1,2]] },
    H2O:   { label:'H‚ÇÇO', atoms:[{ax:-18,ay:10,rad:8,color:'#3aa6fc',label:'H'},{ax:18,ay:10,rad:8,color:'#3aa6fc',label:'H'},{ax:0,ay:-12,rad:14,color:'#2abafa',label:'O'}], bonds:[[2,0],[2,1]] },
    N2:    { label:'N‚ÇÇ', atoms:[{ax:-18,ay:0,rad:12,color:'#f7a643',label:'N'},{ax:18,ay:0,rad:12,color:'#f7a643',label:'N'}], bonds:[[0,1]] },
    NO:    { label:'NO', atoms:[{ax:-12,ay:0,rad:12,color:'#f7a643',label:'N'},{ax:12,ay:0,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1]] },
    NO2:   { label:'NO‚ÇÇ', atoms:[{ax:-18,ay:0,rad:12,color:'#f7a643',label:'N'},{ax:18,ay:-8,rad:14,color:'#2abafa',label:'O'},{ax:18,ay:10,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1],[0,2]] },
    SO2:   { label:'SO‚ÇÇ', atoms:[{ax:-18,ay:0,rad:16,color:'#d3e605',label:'S'},{ax:18,ay:-8,rad:14,color:'#2abafa',label:'O'},{ax:18,ay:10,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1],[0,2]] },
    OH:    { label:'OH', atoms:[{ax:-12,ay:0,rad:14,color:'#2abafa',label:'O'},{ax:12,ay:0,rad:8,color:'#3aa6fc',label:'H'}], bonds:[[0,1]] },
    H:     { label:'H', atoms:[{ax:0,ay:0,rad:8,color:'#3aa6fc',label:'H'}], bonds:[] },
    HSO3:  { label:'HSO‚ÇÉ', atoms:[{ax:-22,ay:0,rad:16,color:'#d3e605',label:'S'},{ax:6,ay:-14,rad:14,color:'#2abafa',label:'O'},{ax:6,ay:8,rad:14,color:'#2abafa',label:'O'},{ax:26,ay:0,rad:8,color:'#3aa6fc',label:'H'}], bonds:[[0,1],[0,2],[0,3]] },
    H2SO4: { label:'H‚ÇÇSO‚ÇÑ', atoms:[{ax:-26,ay:0,rad:16,color:'#d3e605',label:'S'},{ax:6,ay:-20,rad:14,color:'#2abafa',label:'O'},{ax:6,ay:-2,rad:14,color:'#2abafa',label:'O'},{ax:6,ay:16,rad:14,color:'#2abafa',label:'O'},{ax:26,ay:10,rad:8,color:'#3aa6fc',label:'H'}], bonds:[[0,1],[0,2],[0,3],[3,4]] },
    O:     { label:'O', atoms:[{ax:0,ay:0,rad:14,color:'#2abafa',label:'O'}], bonds:[] },
    UV:    { label:'UV', atoms:[{ax:0,ay:0,rad:30,color:'var(--color-uv)',label:'‚òÄÔ∏è'}], bonds:[] }, 
    CFC:   { label:'CFC', atoms:[{ax:0,ay:0,rad:16,color:'#333',label:'C'},{ax:-16,ay:-10,rad:11,color:'#825217',label:'F'},{ax:16,ay:-10,rad:10,color:'#82c42b',label:'Cl'},{ax:0,ay:18,rad:10,color:'#82c42b',label:'Cl'},{ax:-16,ay:10,rad:10,color:'#82c42b',label:'Cl'}], bonds:[[0,1],[0,2],[0,3],[0,4]] },
    Cl:    { label:'Cl', atoms:[{ax:0,ay:0,rad:10,color:'#82c42b',label:'Cl'}], bonds:[] },
    ClO:   { label:'ClO', atoms:[{ax:-12,ay:0,rad:10,color:'#82c42b',label:'Cl'},{ax:12,ay:0,rad:14,color:'#2abafa',label:'O'}], bonds:[[0,1]] },
    HNO3:  { label:'HNO‚ÇÉ', atoms:[{ax:-20,ay:0,rad:12,color:'#f7a643',label:'N'},{ax:10,ay:-14,rad:14,color:'#2abafa',label:'O'},{ax:10,ay:10,rad:14,color:'#2abafa',label:'O'},{ax:26,ay:0,rad:8,color:'#3aa6fc',label:'H'}], bonds:[[0,1],[0,2],[2,3]] },
    HCl:   { label:'HCl', atoms:[{ax:-12,ay:0,rad:10,color:'#82c42b',label:'Cl'},{ax:12,ay:0,rad:8,color:'#3aa6fc',label:'H'}], bonds:[[0,1]] }
};


/* ------------------------------
    UI & Metrics (Declaradas para prevenir 'no definidas')
    ------------------------------ */
function updateMetrics(){
    document.getElementById('totalVal').innerText = molecules.length;
    document.getElementById('o3Val').innerText = molecules.filter(m=>m.type==='O3').length;
    document.getElementById('cfcVal').innerText = molecules.filter(m=>m.type==='CFC').length;
    document.getElementById('h2so4Val').innerText = molecules.filter(m=>m.type==='H2SO4' || m.type==='HNO3' || m.type==='HCl').length; 
}
function showReaction(txt) { 
    document.getElementById('reaction').innerHTML = '√öltima reacci√≥n: **' + txt + '**'; 
    updateMetrics(); 
}
function flash(x,y, color){ effects.push({type:'flash',x,y,t:0,ttl:0.5, color:color}); }
function ozoneHole(x,y){ effects.push({type:'ozone',x,y,t:0,ttl:1.1}); }
function acidicCloud(x,y){ effects.push({type:'acid',x,y,t:0,ttl:1.6}); }


/* ------------------------------
    Molecule Management
    ------------------------------ */
function rand(a, b) { return a + Math.random() * (b - a); }
function estimateRadius(atoms) {
    let max = 12;
    atoms.forEach(a => { 
        const d = Math.hypot(a.ax, a.ay) + (a.rad || 10); 
        if (d > max) max = d; 
    });
    return max;
}

function createMolecule(type, x = null, y = null) {
    const def = DEFS[type];
    if (!def || !W || !H || INTERACT_TOP === undefined) { return null; }
    x = x === null ? rand(W * 0.15, W * 0.85) : x;
    y = y === null ? rand(INTERACT_TOP + 60, H * 0.8) : y;
    
    if (y < INTERACT_TOP + 60) y = INTERACT_TOP + 60; 
    
    const atoms = JSON.parse(JSON.stringify(def.atoms));
    const bonds = JSON.parse(JSON.stringify(def.bonds || []));
    const r = estimateRadius(atoms) + 8;
    const m = { id: nextId++, type, label: def.label, x, y, r, atoms, bonds, vx: rand(-0.12, 0.12), vy: rand(-0.06, 0.06), fixed: false };
    molecules.push(m);
    return m;
}

function spawnFromBottom(type, count = 1) {
    for (let i = 0; i < count; i++) {
        const startX = rand(W * 0.15, W * 0.85);
        const startY = H + rand(20, 80); 
        const m = createMolecule(type, startX, startY);
        if (m) { 
            m.vx = rand(-0.08, 0.08); 
            m.vy = -(0.28 + Math.random() * 0.25); 
        } 
    }
}

function createClouds() {
    clouds = [];
    if (INTERACT_TOP === undefined) return;
    for (let i = 0; i < 4; i++) {
        clouds.push({ 
            x: rand(W * 0.2, W * 0.8), 
            y: rand(H * 0.05, INTERACT_TOP - 20), 
            w: rand(W * 0.15, W * 0.25), 
            h: rand(H * 0.05, H * 0.1) 
        });
    }
}

function produceLightning(x, y) {
    effects.push({ type: 'light', x, y, t: 0, ttl: 0.9 });
    createMolecule('NO', x + rand(-12, 12), y + rand(18, 36));
    createMolecule('NO', x + rand(-14, 14), y + rand(20, 40));
    createMolecule('O', x + rand(-8, 8), y + rand(8, 28));
    showReaction('‚ö° Rayo: N‚ÇÇ + O‚ÇÇ ‚Üí 2 NO (descarga)');
}

function spawnUV() {
    // La part√≠cula UV es energ√≠a que se mueve r√°pidamente.
    const uv = createMolecule('UV', sun.x + rand(-18, 18), sun.y + sun.r + rand(8, 2));
    if (uv) {
        uv.vx = (W / 2 - uv.x) * 0.002 + rand(-0.08, 0.08); // Hacia el centro
        uv.vy = (H / 2 - uv.y) * 0.002 + rand(-0.08, 0.08);
        uv.r = 12; // Aumentar el radio de interacci√≥n
        showReaction('‚òÄÔ∏è Sol: UV generado');
    }
}

// FUNCI√ìN CR√çTICA CON REACCIONES CORREGIDAS
function reactPair(a, b) {
    const types = [a.type, b.type].sort(); 
    function remove(m) { molecules = molecules.filter(x => x !== m); }
    function spawn(t, x, y) { return createMolecule(t, x + rand(-10, 10), y + rand(-10, 10)); }
    const mx = (a.x + b.x) / 2, my = (a.y + b.y) / 2;

    // 1. FORMACI√ìN Y DESTRUCCI√ìN DE OZONO NORMAL
    if (types[0] === 'O' && types[1] === 'O2') { remove(a); remove(b); spawn('O3', mx, my); showReaction('O‚ÇÇ + O ‚Üí O‚ÇÉ (Formaci√≥n de Ozono)'); flash(mx, my, '#ffffff'); return; }
    // O3 con UV
    if (types[0] === 'O3' && types[1] === 'UV') { remove(a); remove(b); spawn('O2', mx, my); spawn('O', mx, my + 8); showReaction('UV + O‚ÇÉ ‚Üí O‚ÇÇ + O (Destrucci√≥n Natural de Ozono)'); ozoneHole(mx, my); return;}

    // 2. CICLO CATAL√çTICO DEL CLORO (DESTRUCCI√ìN POR CFC)
    // CORRECCI√ìN: CFC + UV ya no libera CO2, solo el Cl catal√≠tico.
    if (types[0] === 'CFC' && types[1] === 'UV') { remove(a); remove(b); spawn('Cl', mx, my); showReaction('CFC + UV ‚Üí Cl + Fragmentos (Liberaci√≥n Catal√≠tica)'); acidicCloud(mx, my); return;}
    
    // Cl + O3
    if (types[0] === 'Cl' && types[1] === 'O3') { remove(a); remove(b); spawn('ClO', mx, my); spawn('O2', mx + 10, my - 10); showReaction('Cl + O‚ÇÉ ‚Üí ClO + O‚ÇÇ (Paso 1: Destrucci√≥n Ozono)'); ozoneHole(mx, my); return;}
    // ClO + O (Regeneraci√≥n del Cl)
    if (types[0] === 'ClO' && types[1] === 'O') { 
        remove(a); remove(b); 
        spawn('Cl', mx, my); 
        spawn('O2', mx + 10, my - 10); 
        showReaction('ClO + O ‚Üí Cl + O‚ÇÇ (Paso 2: Regeneraci√≥n del Cloro Catal√≠tico)'); 
        ozoneHole(mx, my); 
        return;
    }

    // 7. CICLO CATAL√çTICO DEL NITR√ìGENO (NOx)
    if (types[0] === 'NO' && types[1] === 'O3') { 
        remove(a); remove(b); 
        spawn('NO2', mx, my); 
        spawn('O2', mx + 10, my - 10); 
        showReaction('NO + O‚ÇÉ ‚Üí NO‚ÇÇ + O‚ÇÇ (Destrucci√≥n de Ozono por NO - Paso 1)'); 
        ozoneHole(mx, my); 
        return;
    }
    
    // 3. LLUVIA √ÅCIDA (Preparaci√≥n de radicales)
    // H2O con UV
    if (types[0] === 'H2O' && types[1] === 'UV') { remove(a); remove(b); spawn('OH', mx, my); spawn('H', mx + 6, my + 6); showReaction('UV + H‚ÇÇO ‚Üí OH + H (Formaci√≥n de Radicales)'); return;}
    
    // **Manejador de colisi√≥n de UV:** Si UV choca con algo y no reacciona, se consume.
    if (a.type === 'UV') { remove(a); showReaction(`UV absorbido por ${b.label}`); return; }
    if (b.type === 'UV') { remove(b); showReaction(`UV absorbido por ${a.label}`); return; }
    
    // 4. LLUVIA √ÅCIDA (Sulf√∫rico)
    if (types[0] === 'OH' && types[1] === 'SO2') { 
        remove(a); remove(b); 
        spawn('H2SO4', mx, my); // Simplificado: SO2 + OH + (otra H2O/O) -> H2SO4
        showReaction('SO‚ÇÇ + OH ‚Üí H‚ÇÇSO‚ÇÑ (√Åcido Sulf√∫rico Simplificado)'); 
        acidicCloud(mx, my); 
        return;
    }
    
    // 5. LLUVIA √ÅCIDA (N√≠trico)
    if (types[0] === 'NO2' && types[1] === 'OH') { 
        remove(a); remove(b); 
        spawn('HNO3', mx, my); 
        showReaction('NO‚ÇÇ + OH ‚Üí HNO‚ÇÉ (√Åcido N√≠trico)'); 
        acidicCloud(mx, my); 
        return;
    }

    // 6. OXIDACI√ìN DE NO A NO‚ÇÇ (Despu√©s del rayo)
    if (types[0] === 'NO' && types[1] === 'O2') { 
        remove(a); remove(b); 
        spawn('NO2', mx, my); 
        showReaction('NO + O‚ÇÇ ‚Üí NO‚ÇÇ (Oxidaci√≥n atmosf√©rica)'); 
        return;
    }

    showReaction(`Sin reacci√≥n: ${a.label} + ${b.label}`); 
}

function checkNeighborsForReaction(m) {
    for (const other of molecules) {
        if (other === m) continue;
        const collisionThreshold = Math.max((m.r + other.r) * 0.95, 55); 
        if (Math.hypot(m.x - other.x, m.y - other.y) < collisionThreshold) {
            reactPair(m, other); 
            return; 
        }
    }
}


/* ------------------------------
    Input Handling (Mantenido)
    ------------------------------ */
canvas.addEventListener('mousedown', (e) => {
    // ... (El c√≥digo de mouse down se mantiene igual, ya que parece funcionar)
    const px = e.clientX, py = e.clientY; 
    
    let clickedCloud = false;
    for (const c of clouds) {
        if (px > c.x - c.w && px < c.x + c.w && py > c.y - c.h && py < c.y + c.h) {
            produceLightning(px, py);
            clickedCloud = true;
            return;
        }
    }
    
    if (Math.hypot(px - sun.x, py - sun.y) < sun.r) { 
        spawnUV(); 
        return; 
    } 

    if (!clickedCloud) {
        for (let i = molecules.length - 1; i >= 0; i--) {
            const m = molecules[i];
            if (m.y >= INTERACT_TOP && Math.hypot(px - m.x, py - m.y) < m.r) {
                m.fixed = true; 
                m.vx = 0; 
                m.vy = 0;
                m.x = px; 
                m.y = py; 
                
                selectedMolecule = m; 
                molecules.splice(i, 1); 
                molecules.push(m);
                return;
            }
        }
    }
});

canvas.addEventListener('mousemove', (e) => {
    if (selectedMolecule) {
        selectedMolecule.x = e.clientX;
        selectedMolecule.y = e.clientY;
        
        const SAFE_DRAG_TOP = INTERACT_TOP + selectedMolecule.r * 1.5;
        if (selectedMolecule.y < SAFE_DRAG_TOP) selectedMolecule.y = SAFE_DRAG_TOP; 

        checkNeighborsForReaction(selectedMolecule); 
    }
});

canvas.addEventListener('mouseup', () => {
    if (selectedMolecule) {
        const m = selectedMolecule;
        
        m.fixed = false; 
        m.vx = 0; 
        m.vy = 0;
        
        // Aplica un peque√±o impulso aleatorio despu√©s de un breve retraso
        setTimeout(() => {
            if (m.fixed === false) { 
                m.vx = rand(-0.2, 0.2); 
                m.vy = rand(-0.2, 0.2);
            }
        }, 200); 

        selectedMolecule = null;
        showReaction(`Mol√©cula liberada`);
    }
});

/* -------------------------------------------
   EVENTOS TOUCH para iPad, OneScreen y tablets
   ------------------------------------------- */

// Convierte coordenadas t√°ctiles ‚Üí coordenadas canvas
function getTouchPos(evt) {
    const rect = canvas.getBoundingClientRect();
    return {
        x: evt.touches[0].clientX - rect.left,
        y: evt.touches[0].clientY - rect.top
    };
}

canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    const pos = getTouchPos(e);
    const px = pos.x, py = pos.y;

    let clickedCloud = false;

    // Tocar nube = rayo
    for (const c of clouds) {
        if (px > c.x - c.w && px < c.x + c.w &&
            py > c.y - c.h && py < c.y + c.h) {
            produceLightning(px, py);
            clickedCloud = true;
            return;
        }
    }

    // Tocar sol = UV
    if (Math.hypot(px - sun.x, py - sun.y) < sun.r) {
        spawnUV();
        return;
    }

    // Selecci√≥n de mol√©cula
    if (!clickedCloud) {
        for (let i = molecules.length - 1; i >= 0; i--) {
            const m = molecules[i];
            if (m.y >= INTERACT_TOP &&
                Math.hypot(px - m.x, py - m.y) < m.r) {

                m.fixed = true;
                m.vx = 0;
                m.vy = 0;
                m.x = px;
                m.y = py;

                selectedMolecule = m;
                molecules.splice(i, 1);
                molecules.push(m);
                return;
            }
        }
    }
});

canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!selectedMolecule) return;

    const pos = getTouchPos(e);
    selectedMolecule.x = pos.x;
    selectedMolecule.y = pos.y;

    const SAFE_DRAG_TOP = INTERACT_TOP + selectedMolecule.r * 1.5;
    if (selectedMolecule.y < SAFE_DRAG_TOP)
        selectedMolecule.y = SAFE_DRAG_TOP;

    checkNeighborsForReaction(selectedMolecule);
});

canvas.addEventListener("touchend", (e) => {
    e.preventDefault();

    if (selectedMolecule) {
        const m = selectedMolecule;
        m.fixed = false;
        m.vx = 0;
        m.vy = 0;

        setTimeout(() => {
            if (!m.fixed) {
                m.vx = rand(-0.2, 0.2);
                m.vy = rand(-0.2, 0.2);
            }
        }, 200);

        selectedMolecule = null;
        showReaction("Mol√©cula liberada (touch)");
    }
});

/* ------------------------------
    Drawing & Physics
    ------------------------------ */
function updateEffects(dt){
    for(let i=effects.length-1;i>=0;i--){ const e=effects[i]; e.t += dt; if(e.t > e.ttl) effects.splice(i,1); }
}
function drawEffects(){
    // ... (Se mantiene igual)
    for(const e of effects){
        const p = e.t / e.ttl; ctx.globalAlpha = 1 - p; 
        if(e.type==='ozone'){ ctx.fillStyle = 'rgba(20,30,80,0.6)'; ctx.beginPath(); ctx.ellipse(e.x,e.y, 110*(1-p)+10, 60*(1-p)+10,0,0,Math.PI*2); ctx.fill();
        } else if(e.type==='acid'){ ctx.fillStyle = 'rgba(180,200,255,0.7)'; ctx.beginPath(); ctx.ellipse(e.x,e.y, 60*(1-p)+10, 18*(1-p)+4,0,0,Math.PI*2); ctx.fill();
        } else if(e.type==='light'){ ctx.strokeStyle = 'rgba(255,250,200,1)'; ctx.lineWidth = 4; ctx.beginPath(); const sx=e.x, sy=e.y; ctx.moveTo(sx,sy); for(let i=1;i<8;i++) ctx.lineTo(sx + rand(-24,24), sy + i*18 + rand(-8,8)); ctx.stroke(); 
        } else if(e.type==='flash'){ ctx.fillStyle = e.color || '#fff'; ctx.beginPath(); ctx.arc(e.x, e.y, 10 + p * 30, 0, Math.PI * 2); ctx.fill();}
        ctx.globalAlpha = 1;
    }
}
function drawMolecule(m){
    // ... (Se mantiene igual, la l√≥gica de dibujo es correcta)
    // Dibujo de enlaces
    ctx.lineWidth = 3; ctx.strokeStyle = 'rgba(0,0,0,0.4)';
    for(const bp of (m.bonds||[])){ 
        const a = m.atoms[bp[0]], b = m.atoms[bp[1]]; 
        const ax = m.x + a.ax, ay = m.y + a.ay; 
        const bx = m.x + b.ax, by = m.y + b.ay; 
        ctx.beginPath(); ctx.moveTo(ax,ay); ctx.lineTo(bx,by); ctx.stroke(); 
    }
    
    // Dibujo de √°tomos
    for(const a of m.atoms){
        const ax = m.x + a.ax, ay = m.y + a.ay; 
        const rad = a.rad || 10;
        
        ctx.beginPath(); 
        
        // Dibuja el c√≠rculo del √°tomo. Si es UV, usa su color definido.
        if (m.type === 'UV') {
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-uv').trim() || '#ffd54f';
        } else {
            ctx.fillStyle = a.color; 
        }
        
        ctx.arc(ax,ay,rad,0,Math.PI*2); 
        ctx.fill();
        
        // Dibujo de etiqueta (Texto)
        ctx.fillStyle='#fff'; 
        ctx.font = `${Math.max(10,rad)}px Arial`; 
        ctx.textAlign='center';
        ctx.textBaseline = 'middle';
        ctx.fillText(a.label, ax, ay);
    }
}
function drawSun(){
    const s = sun;
    const g = ctx.createRadialGradient(s.x,s.y,s.r*0.2, s.x,s.y,s.r*2.5);
    g.addColorStop(0,'rgba(255,255,200,0.99)'); 
    g.addColorStop(1,'rgba(255,240,160,0.01)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s.x,s.y,s.r*2.5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.fillStyle='#FFD54F'; ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
}
function roundedCloud(x,y,w,h){
    ctx.beginPath(); ctx.ellipse(x,y,w,h,0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x - w*0.28, y + 6, w*0.6, h*0.7, 0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(x + w*0.22, y - 6, w*0.55, h*0.65, 0,0,Math.PI*2); ctx.fill();
}
function drawClouds(dt){
    const TIME_FACTOR = dt * 60;
    for(const c of clouds){
        ctx.fillStyle = 'rgba(255,255,255,0.92)'; 
        roundedCloud(c.x, c.y, c.w, c.h);
        c.x += 0.05 * TIME_FACTOR; 
        if(c.x > W + 120) c.x = -c.w; 
    }
}
function stepPhysics(dt){
    const TIME_FACTOR = dt * 60;
    
    for(const m of molecules){
        if(!m.fixed){
            m.vy += GRAVITY_BOOST * TIME_FACTOR; 
            m.vx += rand(-0.005, 0.005) * TIME_FACTOR; 
            
            m.vx *= AIR_RESISTANCE; m.vy *= AIR_RESISTANCE;
            
            m.x += m.vx * TIME_FACTOR;
            m.y += m.vy * TIME_FACTOR;

            const pad = 36;
            if(m.x < pad){ m.x = pad; m.vx *= -BOUNDARY_DAMPING; }
            if(m.x > W - pad){ m.x = W - pad; m.vx *= -BOUNDARY_DAMPING; }
            
            const SAFE_TOP_BOUNDARY = INTERACT_TOP + m.r * 1.5; 
            if(m.y < SAFE_TOP_BOUNDARY) { 
                m.y = SAFE_TOP_BOUNDARY + rand(1, 3); 
                m.vy = -Math.abs(m.vy) * TOP_DAMPING * 1.5; 
            } 

            if(m.y > H - pad){ m.y = H - pad; m.vy *= -BOUNDARY_DAMPING; }
        } 
    }
}


/* ------------------------------
    Animation loop (Fondo CORREGIDO)
    ------------------------------ */
let last = performance.now();
const BG_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--color-bg-dark').trim() || '#87CEFA';

function loop(ts){
    if (!W || !H || INTERACT_TOP === undefined) return requestAnimationFrame(loop); 
    
    const dt = Math.min(0.06, (ts - last)/1000); last = ts;
    
    // Usar la variable CSS para el color de fondo
    ctx.fillStyle = BG_COLOR; 
    ctx.fillRect(0,0,W,H); 
    
    drawSun();
    drawClouds(dt); 

    stepPhysics(dt);
    updateEffects(dt);

    for(const m of molecules) drawMolecule(m);
    drawEffects();

    requestAnimationFrame(loop);
}


/* ------------------------------
    Initial setup
    ------------------------------ */
function seed(){ 
    if (!W || !H || INTERACT_TOP === undefined) return; 

    spawnFromBottom('O2', 1);
    spawnFromBottom('N2', 1); 
    spawnFromBottom('H2O', 2);
    spawnFromBottom('CO2',2); 
    spawnFromBottom('CFC', 2); 
    createMolecule('O3', W * 0.55, INTERACT_TOP + 100); 
    createMolecule('O3', W * 0.85, INTERACT_TOP + 110);
    createMolecule('O3', W * 0.25, INTERACT_TOP + 105);
    spawnUV();
    
    requestAnimationFrame(loop);
}

// Event Listeners (Mantenidos)
document.querySelectorAll('#controls .roundBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
        const t = btn.dataset.type;
        if(t && t !== 'UV') spawnFromBottom(t,1);
    });
});
document.getElementById('btnLightning').addEventListener('click', ()=>{ 
    produceLightning(W*0.5, H * 0.15); 
    showReaction('‚ö° Rayo generado manualmente');
});
document.getElementById('btnUV').addEventListener('click', spawnUV); 
document.getElementById('popupBtn').addEventListener('click', ()=>{ document.getElementById('modal').style.display='block'; });
document.getElementById('closeModal').addEventListener('click', ()=>{ document.getElementById('modal').style.display='none'; });
setInterval(()=>{ molecules = molecules.filter(m => !(m.y < -200 || m.x < -400 || m.x > W + 400 || m.y > H + 400)); }, 7000);
setInterval(updateMetrics, 800);


// Asegurar que resizeCanvas() se llame primero para definir W, H, INTERACT_TOP
window.onload = () => {
    resizeCanvas();
    seed();
}
</script>

</body>
</html>
